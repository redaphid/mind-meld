# Mindmeld - Unified Conversation Index
# Quick start: docker compose up -d
#
# Required: Set CLAUDE_CODE_PATH and CURSOR_GLOBALSTATE_PATH in .env
# See .env.example for all options

services:
  postgres:
    image: ghcr.io/redaphid/mindmeld-postgres:latest
    container_name: mindmeld-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: mindmeld
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-mindmeld}
      POSTGRES_DB: conversations
    ports:
      - "${POSTGRES_PORT:-5433}:5432"
    volumes:
      - mindmeld-postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mindmeld -d conversations"]
      interval: 10s
      timeout: 5s
      retries: 5

  chroma:
    image: chromadb/chroma:latest
    container_name: mindmeld-chroma
    restart: unless-stopped
    environment:
      CHROMA_SERVER_AUTHN_PROVIDER: ""
      IS_PERSISTENT: "TRUE"
      ANONYMIZED_TELEMETRY: "FALSE"
      CHROMA_SERVER_CORS_ALLOW_ORIGINS: '["*"]'
    ports:
      - "${CHROMA_PORT:-8001}:8000"
    volumes:
      - mindmeld-chroma:/data
    healthcheck:
      test: ["CMD", "bash", "-c", "exec 3<>/dev/tcp/localhost/8000"]
      interval: 10s
      timeout: 5s
      retries: 5

  ollama:
    image: ollama/ollama:latest
    container_name: mindmeld-ollama
    restart: unless-stopped
    ports:
      - "${OLLAMA_PORT:-11434}:11434"
    volumes:
      - mindmeld-ollama:/root/.ollama
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  sync:
    image: ghcr.io/redaphid/mindmeld-sync:latest
    container_name: mindmeld-sync
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      chroma:
        condition: service_healthy
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-mindmeld}
      CHROMA_HOST: chroma
      CHROMA_PORT: 8000
      OLLAMA_URL: ${OLLAMA_URL:-http://ollama:11434}
      EMBEDDING_MODEL: ${EMBEDDING_MODEL:-bge-m3}
      EMBEDDING_DIMENSIONS: ${EMBEDDING_DIMENSIONS:-1024}
      EMBEDDING_BATCH_SIZE: ${EMBEDDING_BATCH_SIZE:-50}
      SUMMARIZE_MODEL: ${SUMMARIZE_MODEL:-qwen3:4b}
      SYNC_INTERVAL_SECONDS: ${SYNC_INTERVAL_SECONDS:-3600}
    volumes:
      - ${CLAUDE_CODE_PATH:-~/.claude}:/root/.claude:ro
      - ${CURSOR_GLOBALSTATE_PATH:-~/.cursor/User/globalStorage}:/root/.config/Cursor/User/globalStorage:ro

  centroid-compute:
    image: ghcr.io/redaphid/mindmeld-centroids:latest
    container_name: mindmeld-centroids
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      chroma:
        condition: service_healthy
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-mindmeld}
      CHROMA_HOST: chroma
      CHROMA_PORT: 8000
      OLLAMA_URL: ${OLLAMA_URL:-http://ollama:11434}
      CENTROID_INTERVAL_SECONDS: ${CENTROID_INTERVAL_SECONDS:-25200}

  mcp:
    image: ghcr.io/redaphid/mindmeld-mcp:latest
    container_name: mindmeld-mcp
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      chroma:
        condition: service_healthy
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-mindmeld}
      CHROMA_HOST: chroma
      CHROMA_PORT: 8000
      OLLAMA_URL: ${OLLAMA_URL:-http://ollama:11434}
      MCP_PORT: 3000
    ports:
      - "${MCP_HTTP_PORT:-3847}:3000"

  # Optional: Cloudflare tunnel for remote access
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: mindmeld-cloudflared
    restart: unless-stopped
    depends_on:
      - mcp
    command: tunnel --no-autoupdate run --token ${CLOUDFLARE_TUNNEL_TOKEN}
    profiles:
      - tunnel

volumes:
  mindmeld-postgres:
  mindmeld-chroma:
  mindmeld-ollama:

networks:
  default:
    name: mindmeld-network
